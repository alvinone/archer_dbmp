{%extends 'dbmp_base.html' %}

{% load staticfiles %}
{% load ip_filters %}
{% load filters_dbmp_mysql_instance %}

<!-- 添加该页面自己需要的 css 模板 -->
{% block css %}
    <link href="{% static 'css/plugins/footable/footable.core.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/toastr/toastr.min.css' %}" rel="stylesheet"/>
{% endblock %}

{% block app_title %}MySQL实例详细信息{% endblock %}

<!-- 其他元素模块 -->
{% block top_element %}
<div class="row fontawesome-icon-list">
    <!-- 添加返回MySQL实例列表按钮 -->
    <div class="fa-hover col-md-2 col-sm-3">
        <a href="{% url 'list_instance_use_business_detail' %}">
            <i class="fa fa-home"></i>
            实例列表
        </a>
    </div>
</div>
{% endblock %}

<!-- 显示该页面主要展示的内容 -->
{% block content %}
<!-- 数据库列表 -->
<section id="databases_section">
    <h2 class="page-header">数据库列表</h2>
     
    <div id="database_list">
        <table class="footable table table-stripped toggle-arrow-tiny table-hover" data-page-size="100">
            <thead>
                <tr>
                    <th class="text-center col-xs-1">#</th>
                    <th class="text-center">数据库名</th>
                    <th class="text-center">同步时间</th>
                </tr>
            </thead>
            <tbody>
            {% for dbmp_mysql_database in dbmp_mysql_databases %}
                <tr id="database_row_{{ dbmp_mysql_database.mysql_database_id }}">
                    <td class="text-center col-xs-1">
                        <input type="checkbox" name="database_check" class="database_check"
                               id="database_check_{{ dbmp_mysql_database.mysql_database_id }}" 
                               value="{{ dbmp_mysql_database.mysql_database_id }}" />
                    </td>
                    <td class="text-center">{{ dbmp_mysql_database.name }}</td>
                    <td class="text-center">{{ dbmp_mysql_database.update_time | date:"Y-m-d H:i:s" }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <h4>&nbsp;</h4>

    <div class="row">
        <div class="col-sm-4 col-sm-offset-9">
            <button id="save_business_database" type="button" class="btn btn-info">
                <i class="fa fa-save"></i>
                保存
            </button>
        </div>
    </div>
<section>
{% endblock %}

<!-- 添加该页面自己需要的 js 模板 -->
{% block js %}
    <script src="{% static 'js/content.min.js' %}"></script>
    <script src="{% static 'js/plugins/footable/footable.all.min.js' %}"></script>
    <script src="{% static 'js/plugins/toastr/toastr.min.js' %}"></script>

    <script>
        // 使用 Django csrf 功能
        $.ajaxSetup({headers: {"X-CSRFToken": '{{ csrf_token }}'}});

        $(document).ready(function(){
            // 点击保存时添加数据
            $("#save_business_database").click(function(){
                // 禁用button
                $(this).attr("disabled", true);
                // 获取选中的 checkbox, 并保存
                update_business_database({{ mysql_business_id }});
                // 启用button
                $(this).removeAttr("disabled");
            });
        });

        // 更新业务选取的数据库
        function update_business_database(mysql_business_id) {
            // 获取选中的 checkbox 数据库 id 使用逗号隔开
            database_ids = get_check_database();
            
            $.ajax({
                url: "{% url 'dbmp_mysql_business_detail_ajax_update_database' %}",
                type: "POST",
                dataType: "json",
                data: {
                    mysql_database_ids: database_ids,
                    mysql_business_id: mysql_business_id
                }
            }).done(function(data) {
                if (data == true){
                    console.log('修改成功');
                } else {
                    console.log('修改失败');
                }
            }).error(function(data) {
                toastr.warning("渲染数据失败");
            });
        }

        // 获取数据库id字符串
        function get_check_database() {
            var database_ids = [];  
            var check_content = $("input[name='database_check']:checked")  
            check_content.each(function () {  
                database_ids.push(this.value);  
            });

            return database_ids;
        }

    </script>
{% endblock %}
